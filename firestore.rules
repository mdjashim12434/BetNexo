
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if the requesting user is an Admin.
    // It reads the 'role' field from the user's document in the 'users' collection.
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
    }
    
    // USERS Collection Rules:
    // - Users can read and create their own document.
    // - Users can update their non-critical info (like name), but NOT balance or role.
    // - Admins have full write access to any user document.
    match /users/{userId} {
      allow read, create: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId && 
                       !('balance' in request.resource.data) && 
                       !('role' in request.resource.data);
      allow write: if isAdmin();
    }
    
    // BETS Collection Rules:
    // - Users can create their own bets and read their own bet history.
    // - Users cannot update or delete bets once placed.
    // - Admins can read and write (including update/delete) any bet document.
    match /bets/{betId} {
      allow read: if resource.data.userId == request.auth.uid || isAdmin();
      allow create: if request.auth.uid != null && request.resource.data.userId == request.auth.uid;
      // Users cannot update/delete. Admins have full write access.
      allow write: if isAdmin(); 
    }

    // TRANSACTIONS Collection Rules (Deposits & Withdrawals):
    // - Users can create their own transaction requests (deposit/withdrawal).
    // - Users can read their own transaction history.
    // - Only Admins can update a transaction (to approve/reject it). Users cannot modify requests.
    // - Admins can delete transaction records if necessary.
    match /transactions/{transactionId} {
      allow read: if resource.data.userId == request.auth.uid || isAdmin();
      allow create: if request.auth.uid != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAdmin();
    }
    
    // PAYMENTMETHODS Collection Rules:
    // - All authenticated users can read the list of available payment methods.
    // - Only Admins can create, update, or delete payment methods.
    match /paymentMethods/{methodId} {
      allow read: if request.auth.uid != null;
      allow write: if isAdmin();
    }
  }
}
